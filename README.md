# coupon_platform
쿠폰과 관련된 다양한 기능들을 마음대로 구현해보기 위한 저장소<br>
주요 기능들에 집중하기 위해 상품, 사용자 등과 같은 도메인 관련 내용은 구현하지 않음

[자세한 내용은 노션으로 문서화](https://languid-visage-6fe.notion.site/Wiki-967b2f3f21d14a7fb84f8bc9791a2f04?pvs=4)

# 1. 기술 스택
- kotlin 1.8.10
- Spring Boot 3.1.3
- Spring Data JPA
- Gradle 8.0
- TSID
- kotest, mockk
- MySQL 8.0.34

# 2. 주요 기능
2-1. 코드입력을 통한 쿠폰 발급<br>
2-2. 출석체크 쿠폰 발급 이벤트<br>
2-3. 선착순 쿠폰 발급 이벤트<br>

## 2-1. 코드입력을 통한 쿠폰 발급
### 2-1-1. 요구사항

난수를 사용하는 곳은 총 세군데다.
  1. **쿠폰 코드**
  2. **엔티티의 외부 노출 id**
  3. **요청 트래킹 id**

**[공통 조건]**
1. 난수는 중복되면 안된다.
    1. 분산 환경이어도 중복되서는 안된다.
2. 난수는 영문자, 숫자, '-' 로만 이루어져야 한다.

**[쿠폰 코드 조건]**
1. **쿠폰 코드**의 길이는 19글자여야 한다.
    1. ex) `xxxx-xxxx-xxxx-xxxx`
2. 사용자는 **쿠폰 코드**를 입력하면 쿠폰을 발급받는다.
3. 하나의 쿠폰당 하나의 **쿠폰 코드**만 가질 수 있다.
4. 동일한 사용자가, 동일한 **쿠폰 코드**를 여러번 입력해도, 한번만 발급되어야 한다.

**[엔티티의 외부 노출 id]**
- 외부 노출 id의 길이는 12 이어야한다.
- 정렬이 가능해야 한다.

**[요청 트래킹 id]**
- 난수의 길이는 12 이어야 한다.
    - `{prefix} + {난수}`
    - prefix는 쓰레드 id

### 2-1-2. 기술 선택
**[사용 가능한 기술]**
1. 티켓 서버
2. snowflake 서비스
3. UUID, ULID, TSID
   
**[쿠폰 코드, 요청 트래킹 id]**
- 각 19,16자리 길이 조건을 만족하고, 시간순으로 정렬할 필요가 없기 때문에 `UUID` 사용

**[외부 노출 id]**
- 12자리 길이 난수를 생성할 수 있고, 시간순으로 정렬할 수 있는 `TSID` 사용 

### 2-1-3. 클래스 다이어 그램
- 기존 설계
![Untitled](https://github.com/znftm97/coupon_platform/assets/57134526/9112a3fc-257c-4d28-826b-44703690c921)
직접 `UUID.randomUUID()` 또는 `TSID.getTsid()`를 호출해서 사용해도 되지만, 객체지향적으로 구현하여 DIP 개념을 함께 활용했다.

- 코루틴 사용으로 인한 설계 변경
![Untitled (1)](https://github.com/znftm97/coupon_platform/assets/57134526/4144bce7-31a4-4856-9eee-fc5c7bfaf08e)
TSID나 ULID 라이브러리는 시간순으로 정렬할 수 있는 난수를 생성한다. 같은 시간에 난수를 생성하는 경우가 존재할 수 있으니 내부적으로 synchronzied 키워드를 사용하고 있다. 이는 blocking 요소로 코루틴을 이용해 처리하고자 했고, 코루틴을 사용하려면 해당 함수는 suspend 함수여야 하지만 기존 설계한 인터페이스는 suspend 함수가 아니기 때문에, 설계를 변경해야 했다.
최종적으로 suspendable한 난수생성 인터페이스와, 그렇지 않은 난수생성 인터페이스로 분리했다. 현재는 1인터페이스-1구현체 구조이지만, 언제든지 여러 기술을 사용한 구현체들이 추가될 수 있고, 변경될 수 있는 유연한 구조라고 생각한다.

## 2-2. 출석체크 쿠폰 발급 이벤트
## 2-3. 선착순 쿠폰 발급 이벤트
